      SUBROUTINE MLTP2(  P,PSC,IM, JM,    M,DTS,     MXDOP,MGRI, MGRJ,
     1 KDPSI, KDPSJ, DTI, DTJ, LOKI, LOKJ, LOKMN, R, PDI, PDJ ,XLO)
      IMPLICIT REAL*8 (A-H,O-Z)
C
C   VERSION: 01/10/83                  GEODOP V
C   MODIFIED FOR RUNNING ON IBM FORTRAN (G1 OR Q COMPILERS).
C   B. ARCHINAL, DEPT. OF GEODETIC SCIENCE AND SURVEYING,
C   THE OHIO STATE UNIVERSITY, COLUMBUS, OHIO.
C
      DIMENSION P(1), PSC(1), R(1), DUM(3), DUM1( 3), DTI(1),DTJ(1),
     1 KDPSI(1), KDPSJ(1)
      REAL *8 LOKI,LOKJ , LOKEE  ,LOKE, LOKS
C     DTS - AVR. INTERVAL LENGTH
      RLO= .74954D0
      IPS= PDI/1000
      PSI= IPS/10.D0
      RRSI= PDI- IPS* 1000
      SPDI= XLO/DSQRT(2.D0*PSI*PSI +RRSI*RRSI)*1.D 02
      IPS= PDJ/1000
      PSJ= IPS/10.D0
      RRSJ= PDJ- IPS*1000
      SPDJ= XLO/DSQRT(2.D0*PSJ*PSJ +RRSJ*RRSJ)*1.D 02
      KKK= 0
C
C   FIND OVERLAPPING PORTION
C
      LOKS= LOKI
      IF(LOKS.LT.LOKJ) LOKS= LOKJ
      LOKE= LOKI + MGRI* DTS
      LOKEE= LOKJ+MGRJ* DTS
      IF(LOKEE.LT.LOKE) LOKE= LOKEE
      IM= (LOKS-LOKI +.06D0)/ DTS
      JM= (LOKS- LOKJ+.06D0)/ DTS
      IWR= IM
      JWR= JM
      M=   (LOKE- LOKS+ .06D0)/ DTS
      TI= LOKS - LOKMN
      TJ= LOKS - LOKMN
      DO 1 ID= 1,M
      II= IWR +ID
      JJ= JWR + ID
      TE= TI+ DTI(II)
      I= (TI+.05D0)/ DTS
      K= TE/DTS
      IF(K.GT.(I+2)) K= I+2
      J= I-1+K-I
      IF(J.LT.I) J=I
      SC=DSQRT(DTI(II)/DTS)
      ONE= KDPSI(II) /DTS
      DT1=( -TI+I*DTS+DTS*(K-I))* SC *ONE
      DT2= (K-I-1)*DTS*SC *(K-I)* ONE
      DT3= (TE-K*DTS)*SC*ONE
      DCRT= 0.D0
      IF((K-I).GE.2) DCRT=( K-I-1)*DTS*SC *ONE
      DT1= DT1- DCRT
      DT2= DT2- DCRT
      J= J+ 1
      K= K+ 1
       I= I +1
      DO 10 III=   1,   3
10      DUM1(III)= 0.
      I2= J-I +1
      IF(I2.EQ.0) I2= 1
      I3= K-I +1
      JK= KKK+1
      DUM1(1)= P(JK)*DT1 *PSC(I  )
      DUM1(I2)= DUM1(I2) + P(JK)*DT2 *PSC(J)
      DUM1(I3)= DUM1(I3) + P(JK)*DT3 *PSC(K)
      SC= SC* ONE
      IF(II.LT.MGRI)DUM1(I3)=DUM1(I3)+ (DTS*SC -DT3)* KDPSI(II+1)*P(JK+1
     1)*PSC(K)
      KKK= KKK +MXDOP-ID +1
      TI= TE
C
C    SECOND STATION J
C
 
      TE=TJ +DTJ(JJ)
      I= (TJ+.05D0)/ DTS
      K= TE/DTS
      IF(K.GT.(I+2)) K= I+2
      SC=DSQRT(DTJ(JJ)/DTS)
      J= I-1+K-I
      IF(J.LT.I) J=I
      ONE= KDPSJ(JJ)    /DTS
      DT1=( -TJ+I*DTS+DTS*(K-I))* SC *ONE
      DT2= (K-I-1)*DTS*SC *(K-I)* ONE
      DT3= (TE-K*DTS)*SC* ONE
      DCRT= 0.D0
      IF((K-I).GE.2) DCRT=( K-I-1)*DTS*SC *ONE
      DT1= DT1- DCRT
      DT2= DT2- DCRT
      J= J+ 1
      I= I +1
      K= K+1
      DO 13 III=1,3
13     DUM(III)= 0.D0
      I2= J-I +1
      IF(I2.EQ.0) I2=1
      I3= K-I +1
      DUM(1)= P(JK)*DT1
      DUM(I3)= DUM(I3) + P(JK)*DT3
      DUM(I2)= DUM(I2) + P(JK)*DT2
      SC=  SC* ONE
      IF(JJ.LT.MGRJ)DUM(I3)=DUM(I3)+ (DTS*SC -DT3)* KDPSJ(JJ+1)*P(JK+1)
      R(ID)= 0.D0
      DO 14 IJ= 1, 3
14    R(ID)= R(ID) + DUM1(IJ)* DUM( IJ)*SPDI* SPDJ
      TJ= TE
1      CONTINUE
      RETURN
      END                          
      SUBROUTINE MLTP3(P,PSC,LOK,LOKMN,MGR,DT,MXDOP, KDPSI, NSTA,NST,PS,
     1 PSS,RT, PD,RLO, DTS)
      IMPLICIT REAL*8 (A-H,O-Z)
C
C   VERSION: 03/06/83                  GEODOP 5.13 (JAN83-IBM)
C   MODIFIED FOR RUNNING ON IBM FORTRAN (G1 OR Q COMPILERS).
C   B. ARCHINAL, DEPT. OF GEODETIC SCIENCE AND SURVEYING,
C   THE OHIO STATE UNIVERSITY, COLUMBUS, OHIO.
C
      DIMENSION P(1), PSC(1), DT(1), LOK(1), KDPSI(1), MGR(1), PS(1),
     1  DUM(10), PD(1)
      REAL *8 LOK
      KMX= 0
      SMTE= 0
       SMK= 0
C
C   SUBROUTINE (SPECIAL PURPOSE) COMPUTES  SQRT(INV(DT*P*D + PS))
C   AS REQUIRED FOR INTERFEROMETRY APPROACH
C
      CALL PWGHT(P , MXDOP , RT, PS)
C        FORM AND INITILIZE PS (NSAT,NSAT) MATRIX
      DO 1 I=1,NST
1      PSC(I)= PSS
      DO 9 IS=1,NSTA
      IF(MGR(IS).EQ.0)  GO TO 9
      IPS= PD(IS)/1000
      PHS= IPS/10.D0
      RRS= PD(IS)- IPS*1000
      PDD= RLO/(PHS*PHS*2.D0+RRS*RRS)*1.D 04
      TI= LOK(IS)- LOKMN
      KKK=0
      IST= (IS-1)*MXDOP
      MGRI= MGR(IS)
      DO 3 L=1,MGRI
      DO 4 II=1,4
4      DUM(II)= 0.D0
      M= IST + L
      TE= TI + DT(M)
      I= (TI+.05D0)/ DTS
      K= TE/DTS
C  CHECK FOR REALISTIC VALUES
      IF(I.LE.0) I= 1
      IF(K.LT.I) K=I
      IF(K.GT.(I+2)) K= I+2
      J= K-1
      IF(J.LT.I) J=I
      SC=DSQRT(DT(M)/DTS)*KDPSI(M)/DTS
      DT1=( -TI+I*DTS+DTS*(K-I))* SC
      DT3= (TE- K*DTS)*SC
      DT2= (K-I-1)*DTS*SC *(K-I)
      DCRT= 0.D0
      IF((K-I).GE.2) DCRT=( K-I-1)*DTS*SC
      DT1= DT1- DCRT
      DT2= DT2- DCRT
      I= I +1
      J=   J+1
      K= K+1
      JK= KKK +1
      I2= J-I +1
      IF(I2.EQ.0) I2=1
      I3= K-I +1
      DUM(1)= P(JK)* DT1
      DUM(I2)= DUM(I2) + P(JK)* DT2
      DUM(I3)= DUM(I3) + P(JK)*DT3
      IF(L.LT.MGRI)DUM(I3)=DUM(I3)+P(JK+1)*(DTS*SC -DT3)* KDPSI(M+ 1)
C   FORM MATRIX PS
      DO 5 II=I,K
5      PSC(II)= PSC(II) + DUM(II-I+1)*DUM(II-I+1)* PDD
      TI= TE
      KKK= KKK+MXDOP-L+1
  3     CONTINUE
      IF(K.GT.KMX) KMX= K
      SMTE= SMTE + TE - LOK(IS) + LOKMN
      SMK = SMK + MGRI
9      CONTINUE
      NS= KMX +1
C  CHECK FOR REALISTIC VALUES
      IF(NS.GT.NST) NS= NST
      IF(DTS.LT..1D0.OR.DTS.GT.2.D0) DTS= .5D0
C    INVERSE
      DO 6 I=1,NS
6      PSC(I)= 1.D0/PSC(I)
      RETURN
      END
       SUBROUTINE MLTP4(A,P,B,R,MCLA, MCLB,MXRA,MXRB,MXRR, MGR, SGN)
      IMPLICIT REAL*8 (A-H,O-Z)
C
C   VERSION:  9/25/82                  GEODOP IV+V   (JUL81)
C   MODIFIED FOR RUNNING ON IBM FORTRAN (G1 OR Q COMPILERS).
C   B. ARCHINAL, DEPT. OF GEODETIC SCIENCE AND SURVEYING,
C   THE OHIO STATE UNIVERSITY, COLUMBUS, OHIO.
C
C
C   SUBROUTINE COMPUTES  PRODUCT AT*P*B  = R
C   WHERE A(MXRA,MCLA), B(MXRB,MCLB), P(MGR) , R(MXRR,MCLB)
C
      DIMENSION A(1), P(1), B(1), R( 1)
      IDB= -MXRB
      IDR= - MXRR
      DO 1 J=1,MCLB
      IDB= IDB + MXRB
      IDR= IDR + MXRR
      IDA= -MXRA
      DO 1 I= 1,MCLA
      IDA= IDA + MXRA
      IJ= IDR + I
      DO 2 K= 1,MGR
      IK= IDA + K
      KJ= IDB + K
2      R(IJ)= R(IJ) + A(IK)*P(K)*B(KJ)* SGN
1       CONTINUE
      RETURN
      END
       FUNCTION MODULO (I,J)
C
C   VERSION:  9/25/82                  GEODOP IV+V   (JUL81)
C
C        "MODULO    " - AUTHOR        - P.G. LAWNIKANIS
C                     - REFERENCES    - *NONE*
C
C         VARIABLES USED     -I       ,J       ,        ,           %p
C         VARIABLES ALTERED  -MODULO  ,        ,        ,
C
C         VARIABLES RETURNED -MODULO  ,        ,        ,
C
C         EXTERNAL ROUTINES  -*NONE*  ,        ,        ,
C
C         I/O DEVICES        -*NONE*  ,        ,        ,
C
C
       MODULO = I - (I - 1) / J * J
       RETURN
       END
      SUBROUTINE MULTP (NRA,NCA,NCB,ND1,ND2,A,B,RES)
      IMPLICIT REAL*8 (A-H,O-Z)
C
C   VERSION: 01/09/83                  GEODOP IV+V   (JUL81)
C   MODIFIED FOR RUNNING ON IBM FORTRAN (G1 OR Q COMPILERS).
C   B. ARCHINAL, DEPT. OF GEODETIC SCIENCE AND SURVEYING,
C   THE OHIO STATE UNIVERSITY, COLUMBUS, OHIO.
C
C
C     SUBROUTINE COMPUTES A PRODUCT OF TWO GENERAL MATRICES  A[*B
C     NOTE  NO. OF ROWS OF  A = NO. OF ROWS OF B
C
C     ND1  -  ROW DIMENSION OF A AND B
C     ND2  -  ROW DIMENSION OF RES
      DIMENSION A(1), B(1), RES(1)
      KB=-ND1
      KR=-ND2
      DO 1 J=1,NCB
      KA=-ND1
      KB=KB+ND1
      KR=KR+ND2
      DO 1 I=1,NCA
      KA=KA+ND1
      LR=KR+I
      RES(LR)=0.D0
      DO 1 II=1,NRA
      LA=KA+II
      LB=KB+II
1     RES(LR)=RES(LR)+A(LA)*B(LB)
      RETURN
      END
      SUBROUTINE OPTION( IN, IEND, MRCN, STWGHT)
      IMPLICIT REAL*8 (A-H,O-Z)
C
C   VERSION: 01/28/83                  GEODOP 5.11 (STDFTN)
C   MODIFIED FOR RUNNING ON IBM FORTRAN (G1 OR Q COMPILERS).
C   B. ARCHINAL, DEPARTMENT OF GEODETIC SCIENCE AND SURVEYING,
C   THE OHIO STATE UNIVERSITY, COLUMBUS, OHIO.
C
C
C  READS IN AND WRITES OUT OPTIONS, SET DEFAULT VALUES AND CHECKS FOR
C  EOF ON TAPE99=INPUT
C      IN=1   READ + WRITE
C      IN=0          WRITE  OUT ONLY
C    IEND=1  EOF ENCOUNTERED ON TAPE99
C
      DIMENSION DXS(3)
     1, STWGHT(6)
      COMMON /OPT/ ASG,HOR, SIGA,A1,ESQ,DXS,TE,XP99,RT,ALG,ACR,OUT,RHO,
     1 FO, LO, PI, WE, RADG, SGMT, ITTG, ITRIM, IWRT,IOUT,INPT,  NROW
      COMMON /COUNT/  NGRPTS, MACOL, MCCOL, MROW, IPASSC, IACCC,
     1   IPASS, NREJT, NDFRJ , IELEV ,IVRJ , MDFM ,NPTS , ISEQ , IACC
     1 , NORB
      REAL *8 LO
      IEND=0
C      O P T I O N   C A R D  READ IN
C
C     ASG  =1 TROP. REFRACTION  HOPPFIELD"S SIMPLIFIED  MODEL
C          =2                   NRC  SASTAMONIAN        MODEL
C        .NE. 1  TROP.         REF. SUPPRESSED
C     HOR    -     HORIZON  CUT-OFF  CRITERION (DEGREES)
C     ITRIM  =  1  TRIMMING ALL DOPPLER TO KEEP SIMUL. DOPPLER ONLY
C                FROM ALL STA.
C      SIGA  -  APRIORI VAR FACTOR
C     A1     -  SEMIMAJOR AXIS OF REF ELLIPSOID
C     B1     -  SEMIMINOR AXIS OF REF ELLIPSOID
C     DXS,DYS,DZS  -  DATUM SHIFT IN METERS
C  RT -  CORRELATION COEFFICIENT(SERRIALLY CORR. P-MATRIX OF DOPPLERS)
C     ALG    -  ALONG TRK ORBIT CONSTRAIN METERS  1 SIGMA
C     ACR    -  ACCRR.TRK ORBIT CONSTRAIN METERS  1 SIGMA
C     OUT    -  OUT - TRK ORBIT CONSTRAIN METERS  1 SIGMA
C
C     RT  - WEIGHTING MODEL = 0    IDENTITY WEIGHTING
C                           = 1    CORRELATED WEIGHTING NOMINAL(PHASE+R.
C                           = 2    CORRELATED VAR. WEIGHTING MODEL I
C                           = 3    CORRELATED VAR. WEIGHTING MODEL II
C
C--- SET UP UNIT NUMBERS.
      IF(IN.EQ.0) GO TO 19
C  Input Card #2 (see GEODOPV Users's Guide p.5 for more details)
       WRITE(ISCN,'(A\)') ' Printout (1-Extend;2-Normal;5-Short) [5] :'
       READ(ISCN,*) ITTG
       WRITE(ISCN,'(1X,I6)') ITTG
       WRITE(ISCN,'(A\)') ' Tropo (0-BlksBen;1-Hop;2-Sast;5-Blks)[0] :'
       READ(ISCN,*) ASG
       WRITE(ISCN,'(1X,F6.0)') ASG
       WRITE(ISCN,'(A\)') ' Doppler elev cutoff (deg)          [7.5] :'
       READ(ISCN,*) HOR
       WRITE(ISCN,'(1X,F6.1)') HOR
       WRITE(ISCN,'(A\)') ' Trim CPA Dop pass plot sim SWITCH   [10] :'
       READ(ISCN,*) ITRIM
       WRITE(ISCN,'(1X,I6)') ITRIM
       WRITE(ISCN,'(A\)') ' Apriori variance factor(stat tests)[1.4] :'
       READ(ISCN,*) SIGA
       WRITE(ISCN,'(1X,F6.1)') SIGA
       WRITE(ISCN,'(A\)') ' Reference ellipsoid A-6378000(m)[145.00] :'
       READ(ISCN,*) A1
       WRITE(ISCN,'(1X,F6.1)') A1
       WRITE(ISCN,'(A\)') ' Reference ellipsoid B-6356000(m)[759.77] :'
       READ(ISCN,*) B1
       WRITE(ISCN,'(1X,F6.1)') B1
       WRITE(ISCN,'(A\)') ' Datum shift (X,Y,Z) (meter)   [0 0 0 ]   :'
       READ(ISCN,*) DXS
       WRITE(ISCN,'(1X,3F6.1)') DXS
       WRITE(ISCN,'(A\)') ' Pass cut-off angle (deg)           [10]  :'
       READ(ISCN,*) TE
       WRITE(ISCN,'(1X,F6.0)') TE
       WRITE(ISCN,'(A\)') ' Correlation (0-none,1-nom,2-est,3,4) [0] :'
       READ(ISCN,*) RT
       WRITE(ISCN,'(1X,F6.0)') RT
       WRITE(ISCN,'(A\)') ' Read/Write Swtch(4-UpdOrb;8,9-contRed)[0]:'
       READ(ISCN,*) IIWRT
       IF(IWRT.EQ.0) IWRT=IIWRT
       WRITE(ISCN,'(1X,I6)') IWRT
       WRITE(ISCN,'(A\)') ' Sigma(m)(dM,de,dê,di,da,dP)[10 10 10 ...]:'
       READ(ISCN,*) STWGHT
       WRITE(ISCN,'(1X,6F6.0)')STWGHT
       WRITE(ISCN,'(A\)') ' Correlation Analysis (0-no,1-yes)    [0] :'
       READ(ISCN,*) MRCN
       WRITE(ISCN,'(1X,I6)') MRCN
       MRCN= MRCN*10
C  XP99  P.C.  NOR DIST.  LIMITS  +  APRIORI VAR  FOR VEIGHTING
C  CHANGE  IF  REQUIRED
      XP99=2.576
      DO 5 I=1,6
      IF(STWGHT(I).LE.1.D-06) STWGHT(I)= 10.D0
5      CONTINUE
      IF( SIGA.EQ.0.D0) SIGA= 1.4D0
      NDFRJ=0
      IELEV=0
C   REASIGN ITTG TO CONFIRM TO USE IN OTHER SUBROUTINES
      IF(ITTG.EQ.0) ITTG= 5
      IF(ITTG.EQ.2) ITTG= 0
      IF( A1.EQ.0.D0) A1=  145.D0
      IF( B1.EQ.0.D0) B1= 759.77D0
      A1= 6378000.D0 +A1
      B1= 6356000.D0 +B1
      XP99= XP99*DSQRT(SIGA)
      IF( TE.EQ. 0.D0) TE= 10.D0
      IF( HOR.EQ.0.D0 )HOR= 7.5D0
181   FORMAT('0',14X,'TE   =',F5.1,'  PASS ELEV  CUT  OFF'//15X, 'IWRT =
     1',I5,'  =1 READ IN (FROM INPUT) PHASE WEIGHT MATRIX +WRITE CONTINU
     2AT.  FILE'/28X,'=9 READ CONTINUAT. FILE,REWOUND'/28X,'=8 READ CONT
     3. (NOT REWOUND)'/28X,'=10  OUTPUT CLEANED  DATA  FILE     '/29X,'I
     4F.GT.9 NO       CONT FILE WRITTEN'/28X,'=4 OUTPUT UPDT EPHEM ON FI
     5LE ,=14 OUTPUT UPDT EPHEMERIS AND CLEANED DATA WITH UPDT EPH.')
 182  FORMAT('0',14X,'RT   =',F5.2,'  CORRELATION COEFFICIENT'/28X,
     129H.LT. 0.1- IDENTITY WEIGHTING ,/23X,
     127HRT=1 NOMIN. CORR. WEIGHTING/23X, 25HRT=2 COMPUTED RHO,SIGMA
     2/23X,24HRT=3 MEAN RHO COMP SIGMA/23X, 22HRT=4 NOM RHO,COM SIGMA )
      ESQ=(A1*A1-B1*B1)/A1**2
      NREJT=0
      ISEQ=0
      IVRJ=0
19    CONTINUE
C   PRINT OUT OPTIONS
      WRITE(IOUT, 85) ITTG
      WRITE(IOUT, 81)  ASG,HOR,ITRIM,SIGA
      WRITE(IOUT, 181) TE, IWRT
      WRITE(IOUT, 182) RT
      FINV=A1/(A1-B1)
      WRITE(IOUT,83)  STWGHT,A1,B1,FINV
      WRITE(IOUT, 82) DXS
C
      GO TO 17
16    IEND=1
17    RETURN
   81 FORMAT(//15X,'ASG  =',F5.0,2X,'TROPOSPHERIC AND IONOSPHERIC REFRAC
     1TION MODEL'/28X,'=0 BLACKS MODEL WITH BENDING'
     2/28X,'=1 HOPFIELD MODEL'/28X,'=2 SAASTAMOINEN MODEL'
     3/28X,'=5 BLACKS MODEL WITHOUT BENDING'
     4/28X,'ASG+10 THIRD ORDER IONOSPHERIC CORRECTION APPLIED'
     5//15X,'HOR  =',F5.1,2X,'HORIZON CUTOFF CRITERION (DEGREES)'
     6//15X,'ITRIM=',I5  ,2X,'=0-5 NO. OF SETS OF (FREQ. DRIFT,'
     7,' X, Y, Z, R) TO BE PLOTTED, IF.GT.5  NO STATION SUMMARY'/
     4 28X,19H 9-SIMULATION MODE /28X,30HICPA=ITRIM/1000=1 CPA TRIMMING
     1/28X,60HMSTA=(ITRIM-ICPA*1000-ITRM*100)/10 MIN. NO. OF OBS. STATIO
     1NS
     1//15X,'SIGA =',F5.1,2X,'APRIORI VARIANCE FACTOR'
     2,' (FOR STATISTICAL TESTING)')
85    FORMAT('0',///,10X,'OPTIONS USED FOR THIS RUN ARE',///,15X,'ITTG =
     1',I5, '  =1 EXTENDED OUTPUT',/28X,'=5 SHORT OUTPUT'/28X,'=0 NORMAL
     2 OUTPUT')
82    FORMAT(1H0,10X,20HDATUM SHIFT (METERS),20X, 3HDX=,F8.2,3X,3HDY=,
     1F8.2, 3X,3HDZ=,F8.2)
   83 FORMAT(/15X,'ORBIT CONSTRAINTS(1 SIGMA-METERS): DM,DEX,DCO'
     1,',DI,DA,DO - ',6F5.1,
     2//10X'REFERENCE ELLIPSOID'//15X,'SEM.MAJ. A=',F10.2,' M '
     3,10X,' SEM MIN. B=',F10.2,10X,'INVERSE FLAT. 1/F=',F10.4//)
84    FORMAT(I2,F3.0,F5.1,I5,F5.2,7F5.1,3X,I2,6F3.0,I2)
      END
      SUBROUTINE ORBUPD(XS, BASE, DORB, DLT, IDERV, ANRM, V, IACC, IACCC
     1 ,NDESC, OUT, IDAY, NGR, ELMAX, NGRPTS, VARORB)
      IMPLICIT REAL*8 (A-H,O-Z)
      CHARACTER*10 NDESC
      CHARACTER*4 ISRC
C
C   VERSION: 03/06/83                  GEODOP 5.11 (STDFTN)
C   MODIFIED FOR RUNNING ON IBM FORTRAN (G1 OR Q COMPILERS).
C   B. ARCHINAL, DEPT. OF GEODETIC SCIENCE AND SURVEYING,
C   THE OHIO STATE UNIVERSITY, COLUMBUS, OHIO.
C
C   FOR G1 OPERATION:
C   1. "IT2" LOCATION CHANGED IN "SAT" LABELED COMMON TO GIVE
C      CORRECT ALIGNMENT.
C
      DIMENSION ROT(3,3), CXYZ(10,3), ANRM(10,10),V(1)
      DIMENSION XS(   60,3),BASE(10,60),DORB(6),DT(4)
     1,DXDM(3), DXDEX(3)
      DIMENSION DXTDCO(3), DXTDI(3), DXTDO(3), DXTDA(3), DXTDEX(3),
     1   DXTDM(3)
      DIMENSION NGR(1), ELMAX(1), VARORB(21)
C   SUBPROGRAM UPDATE ORBITS (CHEBYSHEV COEFICIENTS) ACCORDING DORB
C  SOLUTION VECTOR
      COMMON /SAT/ LOKR,IMIN,IST,IT2,FS,NSTA,NDOP,CXYZ,DT,BIT,CMIN,
     1 DTP, AN, EXC, OMEGA, COMEGA, GLAM, DINCL, CPA, IORD
      DATA ISRC/'UPDT'/
C  KEPPLER   ELEMENTS
C     DSIN(XX)= SIN(XX)
C     DCOS(XX)= COS(XX)
      IF4=4
C   COMPUTE SAT COORD. AND VELOCITIES AT 1 MIN INTERVALS
       WE= 4.3752691D-03
      ITWO= IMIN
      IF(ITWO.GT.30) ITWO= 30
      TK= 2.D0/(IMIN-1)
      T= 0.D0
      DSI=DSIN(DINCL)
      DCI=DCOS(DINCL)
      DSO=DSIN(OMEGA)
      DCO=DCOS(OMEGA)
      AE= (.3986005D15/AN**2*3.600D 03)**.333333333D0
      DO 1 I=1,ITWO
      N= ITWO +I
      Y= T*TK -1
      CALL CHEBY(BASE(1,I),BASE(1,N),1,IORD,Y,TK)
      DTR= DTP + T
      FMK= AN* DTR
      EK= FMK+ EXC*DSIN(FMK) + EXC**2*DSIN(2.D0*FMK)/2.D0
      CR   = -COMEGA+ GLAM+ WE*DTR
      WX=DSQRT(1.000000D00-EXC**2)
      DCCO=DCOS(CR)
      DSCO=-DSIN(CR)
      ROT(1,1)=  DCCO*DCO- DSCO*DCI*DSO
      ROT(1,2)= - DCCO*DSO - DSCO* DCI* DCO
      ROT(2,1)= DSCO*DCO + DCCO*DCI*DSO
      ROT(2,2)= - DSCO*DSO + DCCO*DCI*DCO
      ROT(3,1)= DSI* DSO
      ROT(3,2)= DSI* DCO
      U1= 0.D0
      U2= 0.D0
      DO 2 J=1,3
      XS(I,J)= CXYZ(1,J)
      XS(N,J)= 0.D0
      DO 3 K=2,IORD
      XS(I,J)= XS(I,J) + BASE(K,I)* CXYZ(K,J)
      XS(N,J)= XS(N,J) + BASE(K,N)* CXYZ(K,J)
3      CONTINUE
      U1= U1 + ROT(J,1)*XS(I,J)
      U2= U2 + ROT(J,2)*XS(I,J)
2      XS(I,J)= XS(I,J) + XS(I,J)/AE*DORB(5)
      RSAT=DSQRT(U1**2+ U2**2)
      IF(IDERV.EQ.1) GO TO 50
C
C    COMPUTE X-DOT DERIVATIVES
C
      DCEK=DCOS(EK)
      QDT= AN*AE/(1.D0-EXC*DCEK)
      DU1=-QDT*DSIN(EK)
      DU2= QDT*DCEK*WX
C    DXT/DCO
      DXTDCO(1)= (-DSCO*DCO- DCCO*DCI*DSO)*DU1 +(DSCO*DSO-DCCO*DCI*DCO)*
     1 DU2
      DXTDCO(2)= ( DCCO*DCO- DSCO*DCI*DSO)*DU1 -(DCCO*DSO+DSCO*DCI*DCO)*
     1 DU2
      DXTDCO(3)=0.D0
C   DXT/DI
      DXTDI(1)= (DSO*DU1+ DCO*DU2)*DSCO*DSI
      DXTDI(2)=-(DSO*DU1+ DCO*DU2)*DCCO*DSI
      DXTDI(3)= (DSO*DU1+ DCO*DU2)*DCI
C   DXT/DO
      DXTDO(1)=(-DCCO*DSO-DSCO*DCI*DCO)*DU1+(-DCCO*DCO+DSCO*DCI*DSO)*DU2
      DXTDO(2)=(-DSCO*DSO+DCCO*DCI*DCO)*DU1+(-DSCO*DCO-DCCO*DCI*DSO)*DU2
      DXTDO(3)= DSI*(DCO*DU1 - DSO*DU2)
C   DXT/DA
      DXTDA(1)= -(ROT(1,1)*DU1+ ROT(1,2)*DU2)/2./AE
      DXTDA(2)= -(ROT(2,1)*DU1+ ROT(2,2)*DU2)/2./AE
      DXTDA(3)= -(ROT(3,1)*DU1+ ROT(3,2)*DU2)/2./AE
C   DXT/DEX
      DU1DEX= DU1*AE**2/RSAT**2*(2.*U1/AE+EXC*U2**2/AE**2/(1.-EXC**2))
      DU2DEX= AN*AE**2/RSAT**2/DSQRT(1.-EXC**2)*(U1**2/RSAT-U2**2/AE/
     1 (1.D0-EXC**2) )
      DXTDEX(1)= ROT(1,1)*DU1DEX+ ROT(1,2)*DU2DEX
      DXTDEX(2)= ROT(2,1)*DU1DEX+ ROT(2,2)*DU2DEX
      DXTDEX(3)= ROT(3,1)*DU1DEX+ ROT(3,2)*DU2DEX
C   DXT/DM
      DU1DM= - AN*U1/(AE/RSAT)**3
      DU2DM= DU1DM/U1*U2
      DXTDM(1)= ROT(1,1)*DU1DM+ ROT(1,2)*DU2DM
      DXTDM(2)= ROT(2,1)*DU1DM+ ROT(2,2)*DU2DM
      DXTDM(3)= ROT(3,1)*DU1DM+ ROT(3,2)*DU2DM
50      CONTINUE
      T= T+  DLT
      DTK= T- CPA
      DO 6 J=1,3
      DXDM(J)=- ROT(J,1)*AE*U2/RSAT**2/WX+ROT(J,2)*AE/RSAT**2*WX*
     1(U1+ AE*EXC)
6     DXDEX(J)= - ROT(J,1)*(AE+U2*U2/RSAT/WX/WX)/RSAT+ ROT(J,2)*U1*U2/
     1RSAT**2/ WX**2
C   DX/DI
      U11= U1
      U22= U2
      U1= U11*DCO - U22*DSO
      U2= U11*DSO+ U22*DCO
      ROT(1,1)= XS(I,3)*DSCO/RSAT
      ROT(2,1)= -XS(I,3)*DCCO/RSAT
      ROT(3,1)= U2*DCI/RSAT
C    DX/DCO
      ROT(1,2)= -XS(I,2)/RSAT
      ROT(2,2)= XS(I,1)/RSAT
      ROT(3,2)= 0.D0
C      DX/DO
                ROT(1,3)= -U2*DCCO/RSAT-U1*DCI*DSCO/RSAT
       ROT(2,3)= -U2*DSCO/RSAT+ U1*DCI*DCCO/RSAT
      ROT(3,3)= U1*DSI/RSAT
      DO 4 J=1,3
      IF(IDERV.EQ.1) GO TO 51
      XS(N,J)= XS(N,J)+ (DXTDA(J)*DORB(5)+(DXTDM(J)*DORB(1)+ DXTDI(J)*
     1  DORB(4)+ DXTDCO(J)*DORB(3)+ DXTDO(J)*DORB(6)+ DXTDEX(J)*DORB(2)
     1 )/AE )
51      CONTINUE
4      XS(I,J)= XS(I,J)+ ROT(J,1)*DORB(4)+ ROT(J,2)*DORB(3)+ ROT(J,3)*
     1 DORB(6)     +DXDM(J)* DORB(1) + DXDEX(J)* DORB(2)
     2 -1.5D0*AN*DXDM(J)*DORB(5)*DTK
1      CONTINUE
      N= ITWO*IDERV
      DO 5 I=1,3
       CALL LESQF2(ANRM, BASE, CXYZ(1,I),XS(1,I),IORD, 10, N, V, SO)
5      CONTINUE
C
C    WRITE UPDATED EPHEMERIS (CHEB. COEFICIENTS) ON "IF4".
C
      ID=0
      I5=NGRPTS
      IF(I5.GT.5) I5=5
      WRITE(NDESC,'(5I2)')(IDINT(ELMAX(I)),I=1,I5)
      DO 60 I=1,I5
      ID= ID*100+ NGR(I)
60      CONTINUE
      IYR= OUT +.1D0- 1900.D0
      CALL DIME(LOKR,IDAY,IH,IMN)
      IF(IACC.EQ.(IACCC+1)) WRITE(IF4) IYR,IST,IDAY,NDESC,ID,ISRC,IORD
      WRITE(IF4)  LOKR, IMIN,((CXYZ(J,I),J=1,IORD),I=1,3)
     1 , IST, NDESC, VARORB
      RETURN
      END
      SUBROUTINE PPLLOT(  N , COORD, NAME, NN, XYZF)
      IMPLICIT REAL*8 (A-H,O-Z)
      CHARACTER*10 NAME
C
C   VERSION: 01/10/83                  GEODOP IV+V   (JUL81)
C   MODIFIED FOR RUNNING ON IBM FORTRAN (G1 OR Q COMPILERS).
C   B. ARCHINAL, DEPT. OF GEODETIC SCIENCE AND SURVEYING,
C   THE OHIO STATE UNIVERSITY, COLUMBUS, OHIO.
C
      DIMENSION COORD(8,NN), XYZF(5)
      DATA RESOLC, RESOLF/ 12.D0,9.D0/
C
C      NN= MAXIMUM NO  OF PASSES TO BE PLOTED
C      E) G) FOR MXDOP= 8
C      MXPS     NN
C       1       50
C       2      120
C       3      250
C       5      600
C
      DO 200 J=1,N
C   PLOT X, Y, Z, DF
      R= RESOLC
      IF(J.EQ.1) R= RESOLF
      ZT=DBLE(IDINT(XYZF(J)))
      XT= ZT-R
      YT= ZT+R
      CALL PRINTP(1,J,XT,YT,ZT,NAME,1,1)
          DO 300 K=1,NN
300       CALL PRINTP(2,J,XT,XT,COORD(J,K),NAME,J,J)
      CALL PRINTP(3,J,XT,XT,XT,NAME,J,J)
200   CONTINUE
      RETURN
      END
       SUBROUTINE PRINTP (MODE,LABEL,XLOWR,XHIGH,VALUE,NAME1,NAME2,LINE)
      IMPLICIT REAL*8 (A-H,O-Z)
      CHARACTER*10 NAME1
C
C   VERSION: 01/09/83                  GEODOP IV+V   (JUL81)
C   MODIFIED FOR RUNNING ON IBM FORTRAN (G1 OR Q COMPILERS).
C   B. ARCHINAL, DEPT. OF GEODETIC SCIENCE AND SURVEYING,
C   THE OHIO STATE UNIVERSITY, COLUMBUS, OHIO.
C
C
C
C        "PRINTP    " - AUTHOR        - P.G. LAWNIKANIS
C                     - WRITTEN ON    - NOVEMBER /73.
C                     - LAST COMPILED - APRIL   1975.
C                     - REFERENCES    - *NONE*
C
C         VARIABLES USED     -MODE    ,LABEL   ,NAME1   ,NAME2
C                             XLOWR   ,XHIGH   ,LINE    ,VALUE
C
C         VARIABLES ALTERED  -*NONE*  ,        ,        ,
C
C         VARIABLES RETURNED -*NONE*  ,        ,        ,
C
C         EXTERNAL ROUTINES  -ABS     ,FLOAT   ,INT     ,
C
C         I/O DEVICES        -OUTPUT = LINE PRINTER
C
C
C   .PRINTP. DOES THE ACTUAL PLOTTING.
C
C   PLOT OF FORM ... .LABEL.TH HEADING , STATION(S) .NAME1. TO .NAME2. ,
C                    BOUNDS .XLOWR. LE .VALUE. LE .XHIGH. , STARTING AT
C
C   .MODE. = 1 ... START NEW PLOT WITH ABOVE DATA.
C          = 2 ... PLOT CURRENT .VALUE..
C          = 3 ... TERMINATE THIS PLOT.
C
C
C      DIMENSION CHAR(121),HEAD(5),IAXIS(13)
      INTEGER CHAR(121),HEAD(3,5),IAXIS(13),BLANK
C      DATA HEAD/10H*FREQ.OFF* , 10H ** DX **  , 10H ** DY **  ,
C    =           10H ** DZ **  , 10H ** DR **  /
      DATA HEAD/'*FRE','Q.OF','F*  ',' ** ','DX *','*   '
     1,         ' ** ','DY *','*   ',' ** ','DZ *','*   '
     2,         ' ** ','DR *','*    ' /
       DATA BLANK/'    '/
       DATA CHAR/121*' ' /
       DATA IPLOT,JT/0,1/
      DATA MASTER/'*   '/,MX/'X   '/
      IOUT=6
       GO TO (10,20,30),MODE
C
C   START NEW PLOT .....
C
   10  IPLOT = IPLOT + 1
       WRITE(IOUT, 5) IPLOT,(HEAD(I,LABEL),I=1,3)
       IF (LABEL.EQ.1) WRITE(IOUT, 15) NAME1
       IF (LABEL.GT.1.AND.NAME2.EQ.BLANK) WRITE(IOUT, 15) NAME1
       IF (LABEL.GT.1.AND.NAME2.NE.BLANK) WRITE(IOUT, 25) NAME1,NAME2
       WRITE(IOUT, 35) XLOWR,XHIGH
       XT = (XHIGH - XLOWR) / 12.D0
       SCALE = 10.D0/XT
       DO 100 I=1,13
               YT =DABS (XLOWR + XT *DBLE (I - 1))
               IAXIS(I) =IDINT(YT -DBLE ((IDINT (YT) / 1000) * 1000))
  100  CONTINUE
       WRITE(IOUT, 45)(IAXIS(I),I=1,13)
       WRITE(IOUT, 55)
       IL = LINE - 1
       XHI = XHIGH
       XLO = XLOWR
       RETURN
C
C   PLOT CURRENT VALUE .....
C
   20  CHAR(JT) = BLANK
       IL = IL + 1
       IT = IL - (IL / 5) * 5
       JT =IDINT((VALUE - XLO) * SCALE + 1.5D0)
       XT = MASTER
       IF (JT.LT.1.OR.JT.GT.121) XT = MX
       IF (JT.LT.1) JT = 1
       IF (JT.GT.121) JT = 121
       CHAR(JT) = XT
       IF (IT.EQ.0) WRITE(IOUT, 65) IL,(CHAR(I),I=1,121),IL
       IF (IT.GT.0) WRITE(IOUT, 75) (CHAR(I),I=1,121)
       RETURN
C
C   END PLOT .....
C
   30  WRITE(IOUT, 55)
       WRITE(IOUT, 45) (IAXIS(I),I=1,13)
       RETURN
C
    5  FORMAT (1H1,/,58X,17H P L O T   S E T ,I2,/,58X,
     $                   20H--------------------,//,63X,2A4,A2/)
   15  FORMAT(60X,8HSTATION ,A10)
   25 FORMAT(54X,8HSTATION ,A10,12H TO STATION ,A10)
   35  FORMAT (/,54X,F11.2,6H  TO  ,F11.2,///)
   45  FORMAT (6X,12(I3,7X),I3)
   55  FORMAT (7X,25(5H[    ))
   65  FORMAT (3X,I3,1H>,121A1,1H@,I3)
   75  FORMAT (7X,121A1)
C
       END
      SUBROUTINE PWGHT(P, MXDOP, RT, PS)
      IMPLICIT REAL*8 (A-H,O-Z)
C
C   VERSION: 01/10/83                  GEODOP IV+V   (JUL81)
C   MODIFIED FOR RUNNING ON IBM FORTRAN (G1 OR Q COMPILERS).
C   B. ARCHINAL, DEPT. OF GEODETIC SCIENCE AND SURVEYING,
C   THE OHIO STATE UNIVERSITY, COLUMBUS, OHIO.
C
C
C     SUBROUTINE FORMS WEIGHT MATRIX (I . E.) SQRT(P) )
C
      DIMENSION P(1), PS(1)
      M= MXDOP
      IF(RT.LE.1.D-1) GO TO 2
      NNN= M*M
      DO 6 I=1,NNN
6      PS(I)= 0.D0
C   FORM OFFDIAGOTNAL MATRIX
      PS(NNN)= 1.D0
      DO 5 I=1,M
      IF(I.EQ.M)  GO TO 5
      IR= (I-1)* M
          PS(IR+I)= 1.D0
      PS(  IR+I+1)= RT
      IRR= IR +M
      PS(IRR+I)= RT
5      CONTINUE
      CALL TRINN(PS, M,1,M)
      KJ= 0
      DO 7 I=1,M
      DO 7 J=I,M
      KJ= KJ +1
      IJ= (J-1)* M +I
7      P(KJ)=PS(IJ)
      GO TO 8
C
C      FORM IDENTITY MATRIX
C
2      CONTINUE
      KK= 0
       DO 3 I= 1,M
      KJ = KK +1
      P(KJ)= 1.D0
      II= I +1
      IF(II.GT.M) GO TO 3
      DO 4 J=II,M
      KJ= KJ +1
4      P(KJ)= 0.D0
      KK= KK+ M- I +1
3      CONTINUE
8     RETURN
      END
      SUBROUTINE PYINT(MYDM,MXPS,NGRPTS,NDGF,NBO, NORB, ISTA, NGR,
     1 SGMT, FDI, TREF, X, PY, PYT ,  CFDI)
      IMPLICIT REAL*8 (A-H,O-Z)
C
C   VERSION: 01/10/83                  GEODOP 5.02 (OCT81)
C   MODIFIED FOR RUNNING ON IBM FORTRAN (G1 OR Q COMPILERS).
C   B. ARCHINAL, DEPT. OF GEODETIC SCIENCE AND SURVEYING,
C   THE OHIO STATE UNIVERSITY, COLUMBUS, OHIO.
C
C   NOTE: CHANGES FROM CDC VERSION ARE:
C   1. UNUSED ST. #3 COMMENTED OUT TO INCREASE EFFICIENCY.
C
C   SUBPROGRAMS USED:
C    . . .
C    FORTRAN:        EXP, SQRT
C
C   SUBROUTINE FORMS OFF-DIAGONAL BIAS MATRIX
C                    PY
      DIMENSION PY(MYDM,MYDM), FDI(8,MXPS), NGR(MXPS),
     1 X(6,MXPS), PYT(MXPS,MXPS),CFDI(5, MXPS)
C
C   ASSIGN SATELLITE CONTRIBUTION SIGMA
C  F-CY  - 1CYCLE/MIN
C  TIMM. -  15 MICRO SEC
C  TR)REF) 1P.C. + SIG**2/2*( WITH 30 KM AND 120KM CORR. DISTANCES
C  F.DRFT 1 PART IN 10**10/ DAY
       M=1
      SUMP1= 0
      SUMP2= 0
      SUMP4= 0
      DO 1 I=1,NGRPTS
      IF(NGR(I).EQ.0) GO TO 1
      IF((TREF-FDI(8,I)).LT.1.D-6) FDI(8,I)=TREF- 4.D00
      DMNI= (TREF- FDI(8,I))*1.6667D-03
      SFI=(CFDI(3,I)*DMNI**2+2.D0*CFDI(2,I)*DMNI+CFDI(1,I)+1.D0)*FDI(2,I
     1)**2
C  UPDATE  SIGMA    COR. TIME= 6 HOURS(360 MIN)
      SIGI= FDI(7,I)*DSQRT(1.   -DEXP((FDI(8,I)- TREF)/ 180.  ))
     1 /DSQRT(SGMT)
      SUMP1= SUMP1 +SGMT / SFI
      SUMP2= SUMP2 + SGMT/ FDI(5,I)**2
      SUMP4= SUMP4 + SGMT/ FDI(4,I)**2
      PYT(M,M)= SIGI**2 +9.D0/SGMT
      K1= I +1
      IF(ISTA.EQ.1) GO TO 1
      IF(K1.GT.NGRPTS) GO TO 1
      N= M
      DO 2 J= K1,NGRPTS
      IF(NGR(J).EQ.0) GO TO 2
      IF((TREF-FDI(8,J)).LT.1.D-6) FDI(8,J)=TREF- 4.D00
C  UPDATE  SIGMA    COR. TIME= 6 HOURS(360 MIN)
      SIGJ= FDI(7,J)*DSQRT(1.D0 -DEXP((FDI(8,J)- TREF)/ 180.D0))
     1 /DSQRT(SGMT)
      N= N+1
      DIST=DSQRT((X(1,J)-X(1,I))**2+(X(2,J)-X(2,I))**2+ (X(3,J)-X(3,I))*
     1*2) +100.D0
      PYT(M,N)= SIGI*(DEXP(-DIST/3.D 04)+DEXP(-DIST/1.2D 05))* SIGJ/2.D0
      PYT(N,M)= PYT(M,N)
2      CONTINUE
      M= M+1
1      CONTINUE
      CALL TRINN (PYT,ISTA,2,MXPS)
C3    CONTINUE
C  FORM PY MATRIX NOW
      K= NORB +1
      NDGF=-ISTA
       M= 1
      DO 4 I=1,NGRPTS
      IF(NGR(I).EQ.0) GO TO 4
      DMNI= (TREF- FDI(8,I))*1.6667D-03
      SFI=(CFDI(3,I)*DMNI**2+2.D0*CFDI(2,I)*DMNI+CFDI(1,I)+1.D0)*FDI(2,I
     1)**2
      PY(K,K)= SGMT/ SFI
      IF(NBO.GE.2) PY(K+1,K+1)= SGMT/ FDI(5,I)**2
      IF(NBO.GE.4) PY(K+3,K+3) = SGMT/FDI(4,I)**2
      IF(NBO.GE.3) PY(K+2,K+2)= PYT(M,M)
      NDGF= NDGF + NGR(I)
      IF(ISTA.EQ.1) GO TO 4
      L= K
      N= M
      DO 5 J=I, NGRPTS
      IF(NGR(J).EQ.0) GO TO 5
      DMNJ= (TREF- FDI(8,I))*1.6667D-03
      SFJ=(CFDI(3,J)*DMNJ**2+2.D0*CFDI(2,J)*DMNJ+CFDI(1,J)+1.D0)*FDI(2,J
     1)**2
      PY(K,L)= PY(K,L)- 1.D0/(SUMP1+.16D0)/SFI/SFJ
      PY(L,K)= PY(K,L)
      IF(NBO.LT.2) GO TO 6
      PY(K+1,L+1)= PY(K+1,L+1) -1.D0/(SUMP2+44.4D0)/FDI(5,J)**2/FDI(5,I)
     1**2
      PY(L+1,K+1)= PY(K+1,L+1)
      IF(NBO.LT.3) GO TO 6
      PY(K+2,L+2)= PYT(M,N)
      PY(L+2,K+2)= PY(K+2,L+2)
      IF(NBO.LT.4) GO TO 6
      PY(K+3,L+3)= PY(K+3,L+3) - 1.D0/(SUMP4+1.D0)/FDI(4,J)**2/FDI(4,I)*
     1*2
      PY(L+3,K+3)= PY(K+3,L+3)
6       CONTINUE
      N= N+1
      L= L +NBO
5      CONTINUE
      M= M +1
      K= K+NBO
   4    CONTINUE
      RETURN
      END
       SUBROUTINE QUICK (A,B,C,D)
      IMPLICIT REAL*8 (A-H,O-Z)
C
C   VERSION: 01/18/83                  GEODOP IV+V   (JUL81)
C   MODIFIED FOR RUNNING ON IBM FORTRAN (G1 OR Q COMPILERS).
C   B. ARCHINAL, DEPT. OF GEODETIC SCIENCE AND SURVEYING,
C   THE OHIO STATE UNIVERSITY, COLUMBUS, OHIO.
C
C   SUBPROGRAMS USED:
C    FORTRAN:        FLOAT, INT
C
C
C   THIS SUBROUTINE COVERTS A COORDINATE IN
C     RADIANS TO ONE IN DEG. MIN. SEC. .....
C
       E = D * 57.2957795129D0
       A =DBLE(IDINT(E))
       E = ( E - A ) * 60.D0
       B =DBLE(IDINT(E))
       C = ( E - B ) * 60.D0
C
       RETURN
       END

